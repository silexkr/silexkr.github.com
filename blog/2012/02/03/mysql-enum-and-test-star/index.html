
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mysql ENUM and Test::* - Silex Blog</title>
  <meta name="author" content="Silex">

  
  <meta name="description" content="MySQL ENUM과 Test:: 이야기 MySQL의 ENUM type 제가 MySQL을 사용한지 약 10년 정도의 시간이 지났습니다. 처음 MySQL을
사용하던 당시 MySQL 3.X는 지금의 MySQL 5.X 버전에 비하면 DB로써
여러가지로 부족한 점이 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://silexkr.github.com/blog/2012/02/03/mysql-enum-and-test-star">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  <script src="http://platform.twitter.com/anywhere.js?id=jeen_lee&v=1" type="text/javascript"></script>
  <script type="text/javascript">
    twttr.anywhere(function (T) {
      T.hovercards();
    });
  </script>
  <link href="/atom.xml" rel="alternate" title="Silex Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Silex Blog</a></h1>
  
    <h2>What the silex.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:silexkr.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Mysql ENUM and Test::*</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-03T19:06:00+09:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h1>MySQL ENUM과 Test:: 이야기</h1>

<h2>MySQL의 ENUM type</h2>

<p> 제가 MySQL을 사용한지 약 10년 정도의 시간이 지났습니다. 처음 MySQL을
사용하던 당시 MySQL 3.X는 지금의 MySQL 5.X 버전에 비하면 DB로써
여러가지로 부족한 점이 많았습니다. - 단일 저장 engine 지원(MyISAM),
컴파일타임 전역 인코딩 지정, FK 지원, View/Trigger/SP 지원등 -
하지만 탁월한 읽기속도를 바탕으로 대중적인 몇몇 PHP 응용프로그램에 성공적으로
탑재되면서 거의 10년간 오픈소스 진영 DB의 대명사로 자리를 잡았고 그동안
많은 우여곡절에도 꾸준히 발전해 현재는 상용 DB와 견주어도 부족하지 않은
다양한 기능을 제공하고 있습니다.</p>

<p> 하지만 개인적으로 그동안 MySQL에 추가된 좋은 최신의 기능들 보다 MySQL
이라는 DB를 떠올리면 가장 먼저 머리속에 떠오르는 애증의 기능이 하나 있습니다.
그것은 바로 오늘 소개할 <code>ENUM</code>이라는 자료형입니다.</p>

<p><code>ENUM</code>은 C 언어, Java등에서 이미 널리 사용되고 있는 enumeration을 의미하는 자료형으로
MySQL에서 <code>ENUM</code>은 단일 컬럼에 미리 지정한 자료만 저장 가능하도록 하는 특수 자료형 입니다.
MySQL.com 에서는 <code>ENUM</code>을 다음과 같이 소개하고 있습니다.</p>

<p>  An ENUM is a string object with a value chosen from a list of permitted values that are enumerated
  explicitly in the column specification at table creation time.</p>

<p><code>ENUM</code> 자료형을 사용할 때 얻을 수 있는 장점은 다음과 같습니다.</p>

<ol>
<li>Text(varchar,char,text)로 값을 저장하는것에 비해 자료의 정합성을 높힐 수 있다</li>
<li>Text + FK 으로 설계하는 것에 비해 Table수를 줄일 수 있다.</li>
<li>enum index 를 통한 연산을 사용할 수 있다.</li>
</ol>


<p> 첫번째 장점은 부연설명이 필요없는 장점입니다. text field 컬럼은 사실상 너무 많이 가능성이 열려있는
컬럼이기 때문에 아무리 응용프로그램에서 정합성을 체크해도 조금만 실수하면 바로 엉뚱한 값들이
들어와 속을 썩이기 마련입니다. 두번째는 조금 논쟁이 있을 수 있는 내용입니다. 사실 앞서 설명한
정합성에 대한 문제를 정석으로 해결하는 방법은 해당 컬럼에 들어올 수 있는 값을 row로 가진 별도의 자료 테이블을
생성하고 그 컬럼에서 FK 제약 조건을 통해 정합성을 확보하는 방식입니다. 이 방식은 어떤 DBMS에서도
사용할수 있는 방법이기 때문에 이식성이 뛰어나다는 장점이 있습니다. 하지만 그런 형태의 제약의 수가 아주 많다면
그 수만큼 테이블이 늘어나거나 혹은 메타정보를 관리하는 별도 테이블을 두고 관리해야 하기 때문에 번거롭습니다.
하지만 <code>ENUM</code>자료 형을 사용할 경우 상대적으로 적은 비용으로 원하는 바를 얻을 수 있기 때문에 경우에 따라서는
훌륭한 대안입니다. 세번째 장점은 의외로 모르는 분들이 많은 기능이지만 개인적으로 MySQL <code>ENUM</code> 자료형의
가장 멋진 기능이라고 생각하는 기능입니다. enum index란 <code>ENUM</code>으로 정의된 컬럼에 입력과 출력에 있어서
지정된 &#8216;값&#8217; 자체 뿐만 아니라 색인(index)값을 이용해 해당 값에 접근할 수 있는 색인을 말합니다. 예를 들면</p>

<pre><code>+-------+-------------------+------+-----+---------+----------------+
| Field | Type              | Null | Key | Default | Extra          |
+-------+-------------------+------+-----+---------+----------------+
| id    | int(11) unsigned  | NO   | PRI | NULL    | auto_increment |
| c1    | enum('a','b','c') | YES  |     | NULL    |                |
+-------+-------------------+------+-----+---------+----------------+
</code></pre>

<p>다음 질의와 결과는 아래와 같습니다.</p>

<pre><code>SELECT id,c1,c1+0 FROM `t1`
+----+------+------+
| id | c1   | c1+0 |
+----+------+------+
|  1 | a    |    1 |
|  2 | b    |    2 |
|  3 | c    |    3 |
+----+------+------+
</code></pre>

<p>그후 다음 질의와 결과는 다음과 같습니다.</p>

<pre><code>INSERT INTO t1(c1) VALUES(1);
SELECT id,c1,c1+0 FROM `t1`
+----+------+------+
| id | c1   | c1+0 |
+----+------+------+
|  1 | a    |    1 |
|  2 | b    |    2 |
|  3 | c    |    3 |
|  4 | a    |    1 |
+----+------+------+
</code></pre>

<p>이처럼 SELECT 문에서 <code>ENUM</code> 자료형 컬럼에 숫자 연산을 하면 색인값을 반환합니다. 마찬가지로 INSERT / UPDATE 문에서
<code>ENUM</code> 자료형 컬럼에 색인을 넣으면 자동으로 해당 컬럼을 넣어줍니다. 이런 특징은 특히 웹 프로그래밍에서 HTML의
Input 요소중 Radio 요소와 아주 궁합이 잘 맞습니다. 예를들면 위에 설명한 c1 컬럼에 값을 넣는
Radio 요소는 다음과 같이 단순하게 작성할 수 있습니다.</p>

<pre><code> &lt;input type="radio" id="c11" name="c1" value="1"&gt; a
 &lt;input type="radio" id="c12" name="c1" value="2"&gt; b
 &lt;input type="radio" id="c13" name="c1" value="3"&gt; c
</code></pre>

<p>이런 방식은 Radio 요소를 많게는 수백개 이상 다뤄야하는 그동안의 작업을 아주 단순하게 만들어 줬습니다.</p>

<h2>Perl test code</h2>

<p>이 포스트는 단순한 <code>ENUM</code> 자료형의 장점뿐만 아니라 그동안 이 자료형을 사용하면서 만났던
몇가지 문제들을 알아보고 재현할 수 있는 perl 코드를 작성해보는것을 목적으로 하고 있습니다.
이런 형태의 문제들은 주로 사용 초기에 발견되지 않고 오랜 기간 수정과 삭제를 반복하다가 발견하곤
하는데 문제에 대한 명확한 재현이 없이는 기존 자료에서 잘못된 내용을 찾는것도 쉽지 않고 같은
실수를 회피하도록 코드를 작성하는데도 많은 어려움이 있었기 때문에 따로 시간을 내서
발생하는 현상에 대해 재현할 수 있는 코드를 작성했습니다.</p>

<p>코드에는 평소에 제가 즐겨쓰는 몇가지 모듈이 사용됩니다. <a href="http://metacpan.org/module/Test::Most">Test::Most</a>, <a href="http://metacpan.org/module/DBIx::Simple">DBIx::Simple</a>,
<a href="http://metacpan.org/module/SQL::Abstract">SQL::Abstract</a>, <a href="http://metacpan.org/module/Test::Databaserow">Test::DatabaseRow</a></p>

<ul>
<li>Test::Most는 Test::More와 이름이 거의 흡사하지만 자주 사용하는 Test::Differences,Test::Deep,Test::Exception 등을
같이 불러주기 때문에 습관적으로 사용합니다.</li>
<li>DBIx::Simple + SQL::Abstract는 복잡하게 ORM을 사용하지 않고 간편하게 DB에 값을 주고 받을 때 사용합니다.</li>
<li>Test::DatabaseRow는 DB의 구조가 아닌 <code>값</code>을 기준으로 검증코드를 만들고자 할때 사용합니다. 최근에 특정작업을 진행
하면서 많이 사용하게 되었습니다.</li>
<li>테스트 코드를 작성할 때 반복사용되는 부분은 최대한 함수로 분리를 하고 실제 검증이 들어가는 부분은
가능하면 block({,})으로 scope를 분리시키면 비슷한 시도의 검증코드를 다수 만들때 복사해서 붙이기 용이합니다.
( &#8220;특히 subtest를 사용하면 test를 개념적으로 분리할 수 있어 더욱 좋다&#8221; by @JEEN_LEE )</li>
</ul>


<h2>Code</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1">#!/usr/bin/env perl</span>
</span><span class='line'><span class="k">use</span> <span class="nn">Test::</span><span class="n">Most</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nn">Test::</span><span class="n">DatabaseRow</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nn">Test::</span><span class="n">Group</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nn">DBIx::</span><span class="n">Simple</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nn">SQL::</span><span class="n">Abstract</span><span class="p">;</span>
</span><span class='line'><span class="k">use</span> <span class="nn">Const::</span><span class="n">Fast</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">const</span> <span class="k">my</span> <span class="nv">$DATABASE</span> <span class="o">=&gt;</span> <span class="s">&#39;testdb&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">const</span> <span class="k">my</span> <span class="nv">$TABLE</span>    <span class="o">=&gt;</span> <span class="s">&#39;t1&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">const</span> <span class="k">my</span> <span class="nv">$COLUMN</span>   <span class="o">=&gt;</span> <span class="s">&#39;c1&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">const</span> <span class="k">my</span> <span class="nv">$DBHOST</span> <span class="o">=&gt;</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">const</span> <span class="k">my</span> <span class="nv">$DBUSER</span> <span class="o">=&gt;</span> <span class="s">&#39;root&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">const</span> <span class="k">my</span> <span class="nv">$DBPASS</span> <span class="o">=&gt;</span> <span class="sx">q()</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">my</span> <span class="nv">$db</span> <span class="o">=</span> <span class="nn">DBIx::</span><span class="n">Simple</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;DBI:mysql:host=$DBHOST&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">$DBUSER</span><span class="p">,</span> <span class="nv">$DBPASS</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">mysql_enable_utf8</span>    <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="n">mysql_auto_reconnect</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span><span class="p">;</span>
</span><span class='line'><span class="nv">$db</span><span class="o">-&gt;</span><span class="n">abstract</span> <span class="o">=</span> <span class="nn">SQL::</span><span class="n">Abstract</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="p">{</span> <span class="n">quota_char</span> <span class="o">=&gt;</span> <span class="s">&#39;`&#39;</span><span class="p">,</span> <span class="n">name_sep</span> <span class="o">=&gt;</span> <span class="s">&#39;.&#39;</span> <span class="p">}</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nb">local</span> <span class="nv">$</span><span class="nn">Test::DatabaseRow::</span><span class="nv">dbh</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="n">dbh</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">subtest</span> <span class="s">&quot;enum column에 컬럼 추가가 발생한경우(POST)&quot;</span> <span class="o">=&gt;</span>  <span class="k">sub </span><span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">%h</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>        <span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="mi">2</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="mi">3</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">3</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">initialize</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | Field | Type              | Null | Key | Default | Extra          |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | id    | int(11) unsigned  | NO   | PRI | NULL    | auto_increment |</span>
</span><span class='line'><span class="c1">#    | c1    | enum(&#39;a&#39;,&#39;b&#39;,&#39;c&#39;) | YES  |     | NULL    |                |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">insert_values</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>    <span class="n">test_column_value</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>    <span class="n">test_column_index</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;ALTER TABLE `$TABLE` CHANGE `$COLUMN` `$COLUMN` ENUM(&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;x&#39;,&#39;y&#39;,&#39;z&#39;)  NULL  DEFAULT NULL&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#    +-------+-------------------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | Field | Type                          | Null | Key | Default | Extra          |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | c1    | enum(&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;x&#39;,&#39;y&#39;,&#39;z&#39;) | YES  |     | NULL    |                |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------------------+------+-----+---------+----------------+</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">test_column_value</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>    <span class="n">test_column_index</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">subtest</span> <span class="s">&quot;enum column에 컬럼 추가가 발생한경우(PRE)&quot;</span> <span class="o">=&gt;</span>  <span class="k">sub </span><span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">%h</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>        <span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="mi">2</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="mi">3</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">3</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">initialize</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | Field | Type              | Null | Key | Default | Extra          |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | id    | int(11) unsigned  | NO   | PRI | NULL    | auto_increment |</span>
</span><span class='line'><span class="c1">#    | c1    | enum(&#39;a&#39;,&#39;b&#39;,&#39;c&#39;) | YES  |     | NULL    |                |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">insert_values</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>    <span class="n">test_column_value</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>    <span class="n">test_column_index</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;ALTER TABLE `$TABLE` CHANGE `$COLUMN` `$COLUMN` ENUM(&#39;x&#39;,&#39;y&#39;,&#39;z&#39;,&#39;a&#39;,&#39;b&#39;,&#39;c&#39;)  NULL  DEFAULT NULL&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#    +-------+-------------------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | Field | Type                          | Null | Key | Default | Extra          |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | c1    | enum(&#39;x&#39;,&#39;y&#39;,&#39;z&#39;,&#39;a&#39;,&#39;b&#39;,&#39;c&#39;) | YES  |     | NULL    |                |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------------------+------+-----+---------+----------------+</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">test_column_value</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>    <span class="n">test_column_index</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span> <span class="c1"># Fail</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">subtest</span> <span class="s">&quot;enum column에 숫자 이름의 컬럼이 들어간 경우(1,2,3)&quot;</span> <span class="o">=&gt;</span>  <span class="k">sub </span><span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">%h</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>        <span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="mi">2</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="mi">3</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;3&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">3</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">initialize</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | Field | Type              | Null | Key | Default | Extra          |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | id    | int(11) unsigned  | NO   | PRI | NULL    | auto_increment |</span>
</span><span class='line'><span class="c1">#    | c1    | enum(&#39;1&#39;,&#39;2&#39;,&#39;3&#39;) | YES  |     | NULL    |                |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">insert_values</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>    <span class="n">test_column_value</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>    <span class="n">test_column_index</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;INSERT INTO t1(id,c1) VALUES(4,1)&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">all_row_ok</span><span class="p">(</span>
</span><span class='line'>        <span class="n">table</span>       <span class="o">=&gt;</span> <span class="nv">$TABLE</span><span class="p">,</span>
</span><span class='line'>        <span class="n">where</span>       <span class="o">=&gt;</span> <span class="p">[</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">4</span> <span class="p">],</span>
</span><span class='line'>        <span class="n">tests</span>       <span class="o">=&gt;</span> <span class="p">[</span> <span class="nv">$COLUMN</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">],</span>
</span><span class='line'>        <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&quot;if input just 1&quot;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;INSERT INTO t1(id,c1) VALUES(5,&#39;1&#39;)&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">all_row_ok</span><span class="p">(</span>
</span><span class='line'>        <span class="n">table</span>       <span class="o">=&gt;</span> <span class="nv">$TABLE</span><span class="p">,</span>
</span><span class='line'>        <span class="n">where</span>       <span class="o">=&gt;</span> <span class="p">[</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">5</span> <span class="p">],</span>
</span><span class='line'>        <span class="n">tests</span>       <span class="o">=&gt;</span> <span class="p">[</span> <span class="nv">$COLUMN</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">],</span>
</span><span class='line'>        <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&quot;if input &#39;1&#39;&quot;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">subtest</span> <span class="s">&quot;enum column에 숫자 이름의 컬럼이 들어간 경우(0,1,2)&quot;</span> <span class="o">=&gt;</span>  <span class="k">sub </span><span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">%h</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>        <span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">},</span>
</span><span class='line'>        <span class="mi">2</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">2</span> <span class="p">},</span>
</span><span class='line'>        <span class="mi">3</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">n</span> <span class="o">=&gt;</span> <span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="mi">3</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">initialize</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | Field | Type              | Null | Key | Default | Extra          |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'><span class="c1">#    | id    | int(11) unsigned  | NO   | PRI | NULL    | auto_increment |</span>
</span><span class='line'><span class="c1">#    | c1    | enum(&#39;0&#39;,&#39;1&#39;,&#39;2&#39;) | YES  |     | NULL    |                |</span>
</span><span class='line'><span class="c1">#    +-------+-------------------+------+-----+---------+----------------+</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">insert_values</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>    <span class="n">test_column_value</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span>
</span><span class='line'>    <span class="n">test_column_index</span><span class="p">(</span><span class="nv">%h</span><span class="p">);</span> <span class="c1">#Fail</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;INSERT INTO t1(id,c1) VALUES(4,1)&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">all_row_ok</span><span class="p">(</span>
</span><span class='line'>        <span class="n">table</span>       <span class="o">=&gt;</span> <span class="nv">$TABLE</span><span class="p">,</span>
</span><span class='line'>        <span class="n">where</span>       <span class="o">=&gt;</span> <span class="p">[</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">4</span> <span class="p">],</span>
</span><span class='line'>        <span class="n">tests</span>       <span class="o">=&gt;</span> <span class="p">[</span> <span class="nv">$COLUMN</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">],</span>
</span><span class='line'>        <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&quot;if input just 1&quot;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;INSERT INTO t1(id,c1) VALUES(5,&#39;1&#39;)&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">all_row_ok</span><span class="p">(</span>
</span><span class='line'>        <span class="n">table</span>       <span class="o">=&gt;</span> <span class="nv">$TABLE</span><span class="p">,</span>
</span><span class='line'>        <span class="n">where</span>       <span class="o">=&gt;</span> <span class="p">[</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">5</span> <span class="p">],</span>
</span><span class='line'>        <span class="n">tests</span>       <span class="o">=&gt;</span> <span class="p">[</span> <span class="nv">$COLUMN</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">],</span>
</span><span class='line'>        <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&quot;if input &#39;1&#39;&quot;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">done_testing</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">sub </span><span class="nf">query</span><span class="p">($)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$db</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;&gt;&gt; &quot;</span><span class="p">,</span> <span class="nv">$query</span><span class="p">,</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">sub </span><span class="nf">initialize</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">%h</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">my</span> <span class="nv">@cols</span> <span class="o">=</span> <span class="nb">map</span> <span class="p">{</span> <span class="nb">sprintf</span> <span class="sx">qq(&#39;$h{$_}-&gt;{n}&#39;)</span> <span class="p">}</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%h</span><span class="p">;</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$enum</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="sx">q{ENUM(%s)}</span><span class="p">,</span><span class="nb">join</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="nv">@cols</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&quot;Database : $DATABASE\n&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;DROP DATABASE IF EXISTS `$DATABASE`&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;CREATE DATABASE `$DATABASE` DEFAULT CHARACTER SET `utf8`&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;USE `$DATABASE`&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;CREATE TABLE `$TABLE` (id INT(11) UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT) DEFAULT CHARACTER SET `utf8` ENGINE = `InnoDB`&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">query</span><span class="p">(</span><span class="s">&quot;ALTER TABLE `$TABLE` ADD `$COLUMN` $enum  NULL  DEFAULT NULL  AFTER `id`&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span> <span class="bp">STDERR</span> <span class="s">&#39;-&#39;</span> <span class="n">x</span> <span class="mi">80</span><span class="p">,</span> <span class="s">&quot;\n&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">sub </span><span class="nf">insert_values</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">%h</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$k</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%h</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$db</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span> <span class="nv">$TABLE</span><span class="p">,</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="nv">$k</span><span class="p">,</span> <span class="nv">$COLUMN</span> <span class="o">=&gt;</span> <span class="nv">$h</span><span class="p">{</span><span class="nv">$k</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;n&#39;</span><span class="p">}</span> <span class="p">}</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">sub </span><span class="nf">test_column_value</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">%h</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$k</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%h</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">all_row_ok</span><span class="p">(</span>
</span><span class='line'>            <span class="n">table</span>       <span class="o">=&gt;</span> <span class="nv">$TABLE</span><span class="p">,</span>
</span><span class='line'>            <span class="n">where</span>       <span class="o">=&gt;</span> <span class="p">[</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="nv">$k</span> <span class="p">],</span>
</span><span class='line'>            <span class="n">tests</span>       <span class="o">=&gt;</span> <span class="p">[</span> <span class="nv">$COLUMN</span> <span class="o">=&gt;</span> <span class="nv">$h</span><span class="p">{</span><span class="nv">$k</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">n</span><span class="p">}</span> <span class="p">],</span>
</span><span class='line'>            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&quot;row $k // $COLUMN is $h{$k}-&gt;{&#39;n&#39;}&quot;</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">sub </span><span class="nf">test_column_index</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">%h</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$k</span> <span class="p">(</span> <span class="nb">sort</span> <span class="nb">keys</span> <span class="nv">%h</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">all_row_ok</span><span class="p">(</span>
</span><span class='line'>            <span class="n">sql</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s">&quot;SELECT $COLUMN + 0 as i FROM $TABLE WHERE id = ?&quot;</span><span class="p">,</span> <span class="nv">$k</span> <span class="p">],</span>
</span><span class='line'>            <span class="n">tests</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="n">i</span> <span class="o">=&gt;</span> <span class="nv">$h</span><span class="p">{</span><span class="nv">$k</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;i&#39;</span><span class="p">}</span> <span class="p">],</span>
</span><span class='line'>            <span class="n">description</span> <span class="o">=&gt;</span> <span class="s">&quot;$k: index of $COLUMN is $h{$k}-&gt;{&#39;i&#39;}&quot;</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ENUM type side effects</h2>

<p>위 테스트를 통해 알수있는 ENUM 자료형 사용시 주의해야할 사항은 다음과 같습니다.</p>

<ol>
<li><code>ENUM</code>으로 정의된 컬럼에 내부 색인에 영향을 주도록 컬럼의 값 순서를 변경하면 DB에 저장된 &#8216;값&#8217;에는 영향이 없지만 색인에는 영향이 생깁니다.</li>
<li><code>ENUM</code>의 값으로 색인과 동일한 숫자를 사용 할 경우 인용부호의 사용에 주의하지 않으면 예상하는 결과와 다른 동작을 초래할 수 있습니다.</li>
</ol>


<p>이 밖에 <code>ENUM</code> 자료형을 사용했을 때 고려해야 할 사항은 다음 링크를 참고하시기 바랍니다. <a href="http://komlenic.com/244/8-reasons-why-mysqls-enum-data-type-is-evil/">8 Reasons Why MySQL&#8217;s ENUM Data Type Is Evil</a></p>

<h2>Conclusion</h2>

<ul>
<li>MySQL의 <code>ENUM</code> 자료형은 경우에 따라 유용하지만 발생할 수 있는 몇 가지 부작용에 주의해야한다.</li>
<li>상황을 재현하는 테스트코드는 문제를 이해하고 공유하는데 도움을 준다.</li>
<li>Test::Most, Test::DatabaseRow 모듈은 테스트 코드 작성에 유용하다.</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">@yongbin</span></span>

      








  


<time datetime="2012-02-03T19:06:00+09:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/mysql/'>mysql</a>, <a class='category' href='/blog/categories/test/'>test</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://silexkr.github.com/blog/2012/02/03/mysql-enum-and-test-star/" data-via="" data-counturl="http://silexkr.github.com/blog/2012/02/03/mysql-enum-and-test-star/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/02/01/silex-techtalk-02-01-2012/" title="Previous Post: Silex Techtalk - 02/01 - 2012">&laquo; Silex Techtalk - 02/01 - 2012</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/02/17/backbone-dot-js/" title="next Post: backbone.js">backbone.js &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/02/21/irc-bot/">IRC bot</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/19/guest-speech-number-1/">Guest Speech #1 - G사 S님</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/17/backbone-dot-js/">backbone.js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/03/mysql-enum-and-test-star/">Mysql ENUM and Test::*</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/01/silex-techtalk-02-01-2012/">Silex Techtalk - 02/01 - 2012</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Silex -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'silexblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://silexkr.github.com/blog/2012/02/03/mysql-enum-and-test-star/';
        var disqus_url = 'http://silexkr.github.com/blog/2012/02/03/mysql-enum-and-test-star/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
